---
title: 'React fiber'
author: "sakakibara"
description: 'Lorem ipsum dolor sit amet'
heroImage: '/blog-placeholder-3.jpg'
pubDate: 2025-10-20
tags: ["astro", "math"]
---

# Introduction
## Contents
## Fix Task
## React Fiberとは

React Fiberは、React 16以降のデフォルトのレコンサイラー（差分検出・更新ロジック）として導入された、JavaScriptオブジェクトです。これはReactの根本的な書き直しであり、長年の課題を解決し、将来的な機能拡張の可能性を広げます。Fiberの主な目標は、アニメーションと応答性の向上であり、作業を分割してタスクの優先順位を付けたり、作業を一時停止して後で再開したり、完了した作業を再利用または不要な場合は中止したりする能力を備えています。従来のStackレコンサイラーとは異なり、非同期処理が可能です。

## 従来のStackレコンサイラーの問題点

従来のStackレコンサイラーは同期的に動作し、スタックが空になるまで処理を中断できませんでした。例えば、テキストフィールドへの入力中にバックグラウンドで要素のレンダリングが発生すると、Stackレコンサイラーがその処理に集中している間、入力に遅延が生じる可能性がありました。これは、Stackレコンサイラーが同期処理であることに起因する主な制限でした。

## Fiberの目的と実装

Fiberはパフォーマンス向上に大きく貢献しますが、それだけが目的ではありません。Reactの動作原理を根本的に変え、より高速でインテリジェントなものにします。また、Reactの開発体験を大幅に向上させ、新機能の追加を容易にします。Fiberは「作業単位」を表すJavaScriptオブジェクトであり、ReactはこのFiberを処理して`finishedWork`を生成し、それをDOMにコミットして視覚的な変更を加えます。このプロセスは、レンダリングフェーズとコミットフェーズの2つのフェーズで実行されます。

## レンダリングフェーズとコミットフェーズ

レンダリングフェーズでは、Reactはユーザーに見えない非同期処理を実行し、タスクの優先順位付け、作業の一時停止や破棄などを可能にします。このフェーズでは、`beginWork()`と`completeWork()`といった内部関数が呼び出され、Fiber（作業単位）が処理されます。コミットフェーズは同期的に実行され、中断できません。このフェーズでは`commitWork()`関数が呼び出され、レンダリングフェーズで決定された変更がDOMに適用されます。

## Fiberオブジェクトのプロパティ

Fiberオブジェクトは、コンポーネントインスタンス、DOMノードなど、「何か」との1対1の関係を持ちます。`tag`プロパティはその種類（例: `FunctionComponent`, `ClassComponent`, `HostComponent`）を示し、`stateNode`プロパティはその「何か」への参照を保持します。React要素と似ていますが、Fiberは可能な限り再利用される点が異なります。`child`、`sibling`、`return`プロパティは、Fiber間の親子関係（ツリー構造）を定義し、それぞれ最初の子供、兄弟、親への参照を保持します。

## 作業（Work）とは

Fiberにおける「作業」とは、状態変更、ライフサイクル関数の呼び出し、DOMの変更につながる更新などを指します。ReactはFiberを処理する際、その作業を直接実行するか、将来のためにスケジュールします。この「タイムスライシング」機能により、アニメーションのような高優先度の作業は迅速に処理され、ネットワークリクエストのような低優先度の作業は遅延させることができます。これは`requestAnimationFrame()`や`requestIdleCallback()`といった関数を用いて実現されます。

## 現在のツリーと作業中のツリー

React Fiberには、「現在のツリー」（画面に表示されているもの）と「作業中のツリー」という2つのFiberツリーが存在します。Reactは現在のツリーを変更する代わりに、作業中のツリーに変更を加え、コミットフェーズで2つのツリーのポインタを入れ替えます。これは、ビデオゲーム開発におけるダブルバッファリングの概念に似ています。

## エフェクト（Effects）

レンダリングフェーズでは、DOMの変更やライフサイクルメソッドの呼び出しといった、コミットフェーズで実行されるべき「エフェクト」がリストアップされます。エフェクトは、DOMの変更（追加、更新、削除）や、`componentDidMount()`のようなライフサイクルメソッドの呼び出しなど、副作用を伴うアクティビティです。これらのエフェクトはFiberに接続され、コミットフェーズで適用されます。

## Fiberツリーの処理プロセス

Reactは、`beginWork()`でツリーを下に降りていき、子を持たないFiberに到達すると`completeWork()`で上に登りながら各Fiberを完了させていきます。このプロセスは再帰的ではなく、`child`、`sibling`、`return`プロパティを利用したループ（Work Loop）によって実現されます。すべてのFiberの処理が完了すると、`commitWork()`が呼び出され、エフェクトが適用されてDOMに変更が反映されます。

## `alternate`プロパティとFiberの利用

`alternate`プロパティは、現在のツリーのFiberと作業中のツリーのFiberを相互に参照するために使用されます。これにより、Fiberオブジェクトの再利用が可能になります。React Fiberによって、エラー境界（Error Boundaries）、Suspense、Concurrent Modeといった機能が実現可能になりました。これらは、エラーハンドリングや非同期処理をより効果的に管理し、ユーザーエクスペリエンスを向上させます。


## 参考
- [youtube react fiber](https://www.youtube.com/watch?v=0ympFIwQFJw)
