---
title: 'パスパラメータの未チェック / ディレクトリトラバーサル'
author: "sakakibara"
description: 'Lorem ipsum dolor sit amet'
heroImage: '/blog-placeholder-3.jpg'
pubDate: 2024-10-19
tags: ["astro", "math"]
---

# パス名パラメータの未チェック / ディレクトリトラバーサル
ウェブアプリの中には, 外部からのパラメータにウェブサーバ内のファイル名を直接指定しているものがある.
このようなウェブアプリでは, ファイル名指定の実装に問題がある場合, 攻撃者に任意のファイルを指定され, ウェブアプリが意図しない処理を行ってしまう可能性がある.
このような攻撃をディレクトリトラバーサル攻撃と呼ぶ.

## Contents
## 発生する危険
- 重要情報の漏洩
- 設定ファイル,　データファイル, プログラムのソースコード等の改ざん, 削除

## 注意が必要なサイト
外部からのパラメータにウェブサーバ内のファイル名を直接指定しているウェブアプリケーションに起こりうる問題である.
個人情報等の重要情報をウェブサーバ内にファイルとして保存しているサイトは特に注意が必要である.

- サーバー内ファイルを利用するウェブアプリケーションの例
  - ウェブページのデザインテンプレートをファイルから読み込む
  - 利用者からの入力内容を指定のファイルへ書き込む

## 根本的解決及び保険的対策
### 根本的解決
#### 外部からのパラメータでウェブサーバ内のファイル名を直接指定する実装を避ける
外部からのパラメータでウェブサーバ内のファイル名を直接指定する実装は, パラメータが改変されることで, 公開予定のないファイルが閲覧される危険性がある.
例えば, hiddenパラメータで指定されたファイル名をテンプレートとして使用する場合, 改変により任意のファイルが出力される恐れがある.
このような実装が本当に必要かを検討し, 他の方法で代替できないかを見直すことが推奨される.

#### ファイルを開く際は, 固定のディレクトリを指定し, かつファイル名にディレクトリ名が含まれないようにする
ファイルを非ｒ買う際に, `open(filename)`で絶対パス名が渡されると任意のディレクトリのファイルが開かれる可能性がある. 対策として, あらかじめ固定のディレクトリ`dirname`を指定して`open(dirname + filename)`の形でコーディングするが, これだけでは`../`を使ったディレクトリトラバーサルを防げない. これを防ぐには, `basename()`などのAPIを使って, ファイル名のみを取り出し, `open(dirname + basename(filename))`の形でコーディングすることが挙げられる.

### 保険的対策
#### ウェブサーバ内のファイルへのアクセス権限の設定を正しく管理する
ウェブサーバ内に補完しているファイルへのアクセス権限が正しく管理されていれば, ウェブアプリが任意のディレクトリのファイルを開く処理を実行しようとしても, ウェブサーバー側の機能でそのアクセスを拒否できる場合がある.

#### ファイル名のチェックを行う
ファイル名を指定した入力パラメータの値から, `/`, `../`, `..¥`等, OSのパス名の解釈としてディレクトリを指定できる文字列を検出した場合, 処理を中止するようにする.
ただし, URLのデコード処理を行っている場合, URLエンコードした`%2F`, `..%2F`, `..%5C`, また, 二重エンコードした`%252F`, `..%252F`, `..%255C`等も検出する必要がある.

## シナリオ: ファイルのダウンロード機能
ウェブアプリケーションで, ユーザがサーバー上のファイルをダウンロードできる機能が提供されているとする.
この機能はユーザーからリクエストされたファイル名をパラメータとして受け取り, サーバー上の特定ディレクトリからそのファイルをダウンロードするというものである.

```python
from flask import Flask, send_file, request

app = Flask(__name__)

@app.route('/download')
def download_file():
    # ユーザーが指定したファイル名をパラメータで受け取る
    filename = request.args.get('file')
    
    # サーバー上の 'files' ディレクトリからファイルを送信
    return send_file(f"files/{filename}")

if __name__ == '__main__':
    app.run()
```
このコードは, ユーザが指定したファイル名を`filename`として取得し, サーバー上の`files`ディレクトリからそのファイルを返す.
ここで, `filename`に対するチェックが行われていないため, 攻撃者はユーザはこれを悪用できる.

ユーザが以下のURLにアクセスしたとする.
```bash
http://example.com/download?file=../../etc/passwd
```
このリクエストは`file`パラメータに`../../etc/passwd`を指定している.
`files/../../etc/passwd`のパスがサーバー上で解決されると, サーバーのルートディレクトリに戻り, `/etc/passwd`というサーバー上の秘密ファイルをダウンロードすることができる.

この攻撃により, サーバー内部のファイルが不正に公開され, 重要な情報が漏洩する可能性がある. この場合, `/etc/passwd`ファイルにはシステムユーザのリストや, ハッシュ化されたパスワードが含まれている場合があり, これが攻撃者に渡ることでセキュリティが破られるリスクが高まる.
