---
title: 'SQLインジェクション'
author: "sakakibara"
description: 'Lorem ipsum dolor sit amet'
heroImage: '/blog-placeholder-3.jpg'
pubDate: 2024-10-19
tags: ["astro", "math"]
---

# SQLインジェクション
多くのウェブアプリは利用者情報をもとにSQL文を組み立ててDBに問い合わせている.
ここで, SQL文の組み立てに問題がある場合, 攻撃者にDBの不正利用を許してしまう恐れがある. このような脆弱性を利用した攻撃を**SQLインジェクション**という.

SQLインジェクションは他の脆弱性に比べて届け出の件数が多い.
届け出の受付開始の2014年4半期から2021年3月までに全体の11%を占めている.

## Contents
## 発生する危険
- DBに蓄積された非公開情報の閲覧: (個人情報の漏洩)
- DBに蓄積された情報の改ざん, 消去: (ウェブページの改ざん, パスワードの変更)
- 認証回避による不正ログイン: (ログインした利用差に許可されている全ての操作を不正に行われる)
- ストアドプロシージャなどを利用したOSコマンドの実行: (システムの乗っ取り, 他の攻撃の踏み台としての悪用)

## 注意が必要なサイト
あらゆるDBを利用しているサイトが注意の対象となる.
個人情報をDBに格納しているウェブサイトは特に注意が必要である.

## 根本的解決及び保険的対策
### 根本的解決
#### SQL文の組み立ては全てプレースホルダで実装する  
SQLには, プレースホルダを使ってSQL文を安全に組み立てる方法がある.
プレースホルダはSQL文の雛形の中に変数の記号(プレースホルダ)を埋め込み, 後にそのプレースホルダに実際の値を割り当てることでSQL文を組み立てる方法である.
これは文字列連結処理によってSQL文を組み立てる方法に比べて, 機械的な処理でSQL文が組み立てられるので, SQLインジェクションの脆弱性を解消できる.
プレースホルダにより, 変数の場所を指定し, 実際の値を後で自動的に割り当てることで, SQLインジェクションの脆弱性を防ぐことができる.
値を割り当てる処理は"バインド"とよばれ, 静的プレースホルダと動的プレースホルダの2つがある.
どちらの方法でもSQLインジェクションを防ぐことができるが, 静的プレースホルダの方が安全性が高いとされている.

#### SQL文の組み立てを文字列連結により行う場合は, エスケープ処理等を行うDBエンジンのAPIを用いて, SQL文のリテラルとして正しく構成する
SQL文を文字列連結により組み立てる場合, 可変な値をリテラルとして埋め込む場合, 適切なエスケープ処理が必要である. 文字列リテラルはシングルクォートで囲み, 特別な意味を持つ記号(例: `'`→`''`, `\`→`\\`)をエスケープする必要がある.
また, 数値リテラルには数値型であることを保証する処理が必要である.
これらの処理はDBエンジンごとに異なるため, 適切な実装が求められる.
専用のAPIがある場合はそれを利用し, 全てのリテラル生成にエスケープ処理を行うべき.


#### ウェブアプリケーションに渡されるパラメータにSQL文を直接指定しない
hiddenパラメータにSQL文を直接指定するというのは論外の実装である.
ウェブアプリケーションに渡されるパラメータにSQL文を直接指定する実装は, そのパラメータ値の改変により, DBの不正利用を許してしまう.

### 保険的対策
#### エラーメッセージをそのままブラウザに出力しない
エラーメッセージにDBの種類やエラー原因, 実行されたSQL文などの情報が含まれていると, SQLインジェクション攻撃に利用される可能性がある. また, エラーメッセージは攻撃の手がかりや結果の確認に悪用されることもある. そのため, DBに関するエラーメッセージは利用者のブラウザに表示しないことが推奨される.

#### DBアカウントに適切な権限を与える
ウェブアプリケーションがDBに接続する際, アカウントの権限が過剰だと攻撃による被害が大きくなる可能性がある. そのため, 実行する命令文に必要最小限の権限だけをアカウントに付与するようにするべき.

## シナリオ
### 代表的なSQLインジェクション
ウェブアプリケーションにおいて, ユーザがログインするために, `username`と`password`を入力するフォームがあるとする. フォームから送信されたデータを元に, アプリケーションはDBに対して以下のようなSQL文を発行するとする.
```bash
query = "SELECT * FROM users WHERE username = '" + username + "' AND password = '" + password + "';"
```
ここで, 
- `username`に`admin' --`
- `password`に`'password'`(任意の文字)
を入力した場合, 以下のようなSQL文が発行される.

```sql
SELECT * FROM users WHERE username = 'admin' --' AND password = 'password';
```
`--`はコメントアウトを表すため, `username`が`admin`であるレコードを取得するSQL文となり, `password`のチェックが無視される. そして, この攻撃により, 攻撃者がpasswordを知らなくても管理者アカウントにログインできてしまう.

### エラーベースSQLインジェクション
商品を検索するウェブアプリケーションがあり, ユーザが商品IDをURLパラメータとして渡す仕組みがある.

```bash
query = "SELECT * FROM products WHERE id = " + product_id + ";"
```
攻撃者は次のようにURLに悪意のある入力を行う.
```bash
http://example.com/products?id=1' OR '1'='1
```
これにより, SQLクエリは次のようになる.
```sql
SELECT * FROM products WHERE id = '1' OR '1'='1';
```
`OR '1'='1'`は常に真となるため, 全ての商品情報が取得される.
さらに, エラーメッセージが表示されることで, データベースに関する情報を漏洩させる可能性がある.

### ブラインドSQLインジェクション
ログインフォームがあり, 攻撃者はブラインドSQLインジェクションを使って, DBから管理者のパスワードを推測しようとする.
攻撃者が次のようなクエリを送信する.
```bash
username = 'admin' AND IF(SUBSTRING(password, 1, 1) = 'a', SLEEP(5), 0)
```
これにより, クエリは次のように構築される.
```sql
SELECT * FROM users WHERE username = 'admin' AND IF(SUBSTRING(password, 1, 1) = 'a', SLEEP(5), 0);
```
もし, passwordの1文字目が'a'であれば, クエリは5秒間停止する.
これにより, 攻撃者はpasswordを1文字ずつ推測することができる.

### ユニオンベースSQLインジェクション
`UNION`を使って, 元々のクエリに攻撃者が指定する別のクエリを結合し, 他のテーブルの情報を取得する手法.

ブログの記事を表示するウェブアプリケーションがあり, ユーザが記事IDを指定して記事を取得する仕組みがあるとする.
```bash
query = "SELECT title, content FROM articles WHERE id = " + article_id + ";"
```
攻撃者は次のようなクエリを送信する.
```bash
article_id = 1 UNION SELECT username, password FROM users
```
これにより, クエリは次のように構築される.
```sql
SELECT title, content FROM articles WHERE id = 1 UNION SELECT username, password FROM users;
```
この結果, アプリケーションは記事だけでなく, `users`テーブルからユーザ名とパスワードを取得してしまう.

### スタッククエリSQLインジェクション
SQL Serverのような一部のDBでは, 複数のSQL文を1つのクエリで実行できる. この機能を利用して, 複数のSQL文を実行することで, データベースの情報を取得する手法.

ユーザーがサポートに問い合わせを送信するフォームがあり, メッセージをDBに保存する仕組みがあるとする.
```bash
query = "INSERT INTO messages (user_id, message) VALUES (" + user_id + ", '" + message + "');"
```
攻撃者は次のようなクエリを送信する.
```bash
message = 'Test'; DROP TABLE users; --
```
これにより, クエリは次のように構築される.
```sql
INSERT INTO messages (user_id, message) VALUES (1, 'Test'); DROP TABLE users; --

```
これによって, `messages`テーブルにメッセージが追加されるだけでなく, `users`テーブルが削除されてしまう.

## 参考
- [IPA 安全なウェブアプリケーション](https://www.ipa.go.jp/security/vuln/websecurity/ug65p900000196e2-att/000017316.pdf)
- [IPA 安全なSQLの呼び出し方](https://www.ipa.go.jp/security/vuln/websecurity.html#sql)
- [IPA 知っていますか? 脆弱性](https://www.ipa.go.jp/security/vuln/vuln_contents/sql.html)
