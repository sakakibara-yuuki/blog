---
title: 'セッションハイジャック'
author: "sakakibara"
description: 'Lorem ipsum dolor sit amet'
heroImage: '/blog-placeholder-3.jpg'
pubDate: 2024-10-19
tags: ["astro", "math"]
---

# セッションハイジャック
ウェブアプリの中には, セッションIDを発行し, セッション管理を行うものがある.
このセッションIDの発行や管理に不備がある場合, 悪意のある人にログイン中の利用者のセッションIDを不正に取得され, その利用者になりすましてアクセスされてしまう可能性がある.
この脆弱性を利用した攻撃をセッションハイジャックと呼ぶ.

## Contents
## 発生する危険
- ログイン後の利用者のみが利用可能なサービスの悪用(不正な送金, 利用者が意図しない商品購入, 利用者が意図しない退会処理)
- ログイン後の利用者のみが編集可能な情報の改ざん, 新規登録(各種設定の不正な変更, 掲示板への不適切な書き込み)
- ログイン後の利用者のみが閲覧可能な情報の閲覧(非公開の個人情報を不正閲覧, ウェブメールを不正閲覧, コミュニティ会員専用の掲示板を不正閲覧)

## 注意が必要なサイト
ログイン機能を持つウェブアプリケーション全体が対象となる.
特に, ログイン後に決済処理等の重要な処理を行うサイトは攻撃による被害が大きくなるため, 注意が必要である.

## 根本的解決及び保険的対策
### 根本的解決
#### セッションIDを推測が困難なものにする
セッションIDが時刻情報などを基にした単純なアルゴリズムで生成されると, 第三者に予測されやすくなり, なりすましによる不正アクセスが発生する可能性がある.
セッションIDは暗号論的擬似乱数生成器を使用して, 予測困難なものにするべきである.
また、セッション管理の仕組みが提供されているウェブアプリケーションサーバを使用すれば, 自前でセッションIDを生成する必要はなく, その仕組みを活用することが推奨される.

#### セッションIDをURLパラメータに格納しない
セッションIDをURLパラメータに格納すると, リンク先に送信されてしまい, 悪意ある人によるセッション・ハイジャックの危険がある.
セッションIDはCookieやPOSTメソッドのhiddenパラメータに格納して受け渡しするべきである.
また, Cookieを拒否した場合に自動的にセッションIDをURLパラメータに切り替える機能があるサーバ製品では, この機能を無効にすることを検討する.

#### HTTPS通信で利用するCookieには`secure`属性を付与する
ウェブサイトのCookieには`secure`属性があり, これを設定するとCookieはHTTPS通信のみで使用される.
`secure`属性がないと, HTTPSで発行されたCookieがHTTP通信でも使用され, 盗聴される可能性がある.
したがって, HTTPS通信で使用するCookieには必ずsecure属性を設定し, HTTP通信用には別のCookieを発行するようにするべきである.

#### ログイン成功後に, 新しくセッションを開始するン ID を無効化します13。こうすることにより、利用者が新しくログインしたセッションに対し、悪意のある
一部のウェブアプリケーションでは, ログイン前に発行したセッションIDをログイン後も継続して使用する実装がある. 対策として, ログイン成功後に新しいセッションIDを発行し, 既存のセッションIDを無効化することで, 事前に盗まれたセッションIDでの不正アクセスを防ぐことができる.

#### ログイン成功後に, 既存のセッションIDとは別に秘密情報を発行し, ページの遷移毎にその値を確認する
ログイン成功後に秘密情報を生成し, Cookieにセットして, 全てのページでその秘密情報が一致することを確認する. この秘密情報は推測が困難なアルゴリズムや暗号処理を用いて生成する.
ただし, セッションIDをログイン後に発行する実装や, 推測困難なセッションIDを使用するといった対策を採用している場合, この対策は不要となる.

### 保険的対策
#### セッションIDを固定値にしない
セッションIDが利用者ごとに固定されていると, 攻撃者に知られた場合, 時間を問わずセッション・ハイジャックが可能になる. セッションIDはログインごとに新しく発行し, 固定しないようにするべきだ.

#### セッションIDをCookieにセットする場合, 有効期限の設定に注意する
Cookieは有効期限までブラウザに保存され, 脆弱性を悪用されると盗まれる可能性がある.
対策として, 有効期限を短く設定するか, ブラウザ終了後にCookieを破棄する設定が推奨される.
ただし, ブラウザを終了しない限り破棄されないため, 効果が限定的な場合がある.
これらの対策により, セッションハイジャックのリスクを軽減することができる.

## シナリオ
### ネットワーク盗聴によるセッションハイジャック
1. ユーザがHTTP通信を使用:  
    ユーザがログイン後, セッションIDがCookieに保存されており, 通信のたびにそのセッションIDがサーバーに送信される.

2. 攻撃者が同じネットワークにいる:  
    公共Wi-Fiなどを利用していると, 攻撃者はネットワーク盗聴(パケットスニッフィング)を行い, ユーザのセッションIDを盗み取る. HTTP通信は暗号化されていないため, セッションIDが簡単に取得される.

3. 攻撃者がセッションIDを使用:  
    攻撃者は盗んだセッションIDを自分のブラウザにセットして, そのセッションを使用して不正にウェブサイトにログインし, ユーザになりすますことができる.

### XSSによるセッションハイジャック
1. 脆弱なウェブサイトにXSSを仕掛ける:  
    攻撃者はXSSの脆弱性を利用して, ウェブサイトに悪意のあるスクリプトを埋め込む.

2. ユーザがスクリプトを実行:  
    ユーザがウェブさいとにアクセスすると, スクリプトが実行され, その結果としてユーザのCookie(セッションID)が攻撃者に送信される.

3. 攻撃者がセッションIDを使用:  
    攻撃者は受け取ったセッションIDを使用して, 不正にユーザのセッションを乗っ取り, ウェブサイトにログインする.

### 予測可能なセッションIDの悪用
1. 単純なアルゴリズムでセッションIDを生成:  
    サーバーが時刻やユーザIDなど, 予測可能な要素に基づいてセッションIDを生成する場合, 攻撃者はそれを予測しやすくなる.

2. 攻撃者がセッションIDを推測:  
    ログイン前のユーザに発行されるセッションIDのパターンを解析し, 攻撃者はそのIDを推測する.

3. 攻撃者がセッションIDを使用:  
    推測したセッションIDを使って, 攻撃者はそのIDを持つユーザのセッションにアクセスし, 不正にログインする.

### セッション固定攻撃
1. 攻撃者が事前にセッションIDを取得する:  
    攻撃者は, ユーザがログインする前に, サイトにアクセスしてセッションIDを取得する.

2. 攻撃者がセッションIDをユーザにセット:  
    攻撃者は, 取得したセッションIDをなんらかの方法(フィッシングなど)を用いてユーザに使わせる.

3. ユーザがそのセッションでログイン:  
    ユーザがそのセッションIDを使ってログインすると, 攻撃者はそのIDを使ってセッションを維持し, ユーザーの権限でサイトにアクセスすることができる.

## 参考
- [IPA 安全なウェブアプリケーション](https://www.ipa.go.jp/security/vuln/websecurity/ug65p900000196e2-att/000017316.pdf)
- [IPA 安全なSQLの呼び出し方](https://www.ipa.go.jp/security/vuln/websecurity.html#sql)
- [IPA 知っていますか? 脆弱性](https://www.ipa.go.jp/security/vuln/vuln_contents/sql.html)
